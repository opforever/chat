<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat</title>
    <script type="module">
        // Your "Dev Apps" Firebase project configuration is now embedded.
        const firebaseConfig = {
          apiKey: "AIzaSyCc3e__RFg81ZD_hjap63V0w6wCAp2iIZU",
          authDomain: "dev-apps-d3c3e.firebaseapp.com",
          projectId: "dev-apps-d3c3e",
          storageBucket: "dev-apps-d3c3e.appspot.com",
          messagingSenderId: "603825738755",
          appId: "1:603825738755:web:0f0601020d17ae6fdfea36",
          measurementId: "G-46VVE0LXV2"
        };
        window.__firebase_config = JSON.stringify(firebaseConfig);

        if (typeof __app_id === 'undefined') {
            window.__app_id = 'default-chat-app';
        }
    </script>
    <style>
        :root {
            --bg-color-light: #f4f4f8;
            --surface-color-light: #ffffff;
            --text-primary-light: #121212;
            --text-secondary-light: #5f5f5f;
            --accent-light: #3498db;
            --border-light: #e0e0e0;

            --bg-color-dark: #121212;
            --surface-color-dark: #1e1e1e;
            --text-primary-dark: #e0e0e0;
            --text-secondary-dark: #a0a0a0;
            --accent-dark: #bb86fc;
            --border-dark: #2c2c2c;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: var(--bg-color-light);
                --surface-color: var(--surface-color-light);
                --text-primary: var(--text-primary-light);
                --text-secondary: var(--text-secondary-light);
                --accent: var(--accent-light);
                --border: var(--border-light);
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: var(--bg-color-dark);
                --surface-color: var(--surface-color-dark);
                --text-primary: var(--text-primary-dark);
                --text-secondary: var(--text-secondary-dark);
                --accent: var(--accent-dark);
                --border: var(--border-dark);
            }
        }
        
        * {
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--surface-color);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #app {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 100vh;
            background-color: var(--surface-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        @media (min-width: 600px) {
            #app {
                max-height: 90vh;
                border-radius: 12px;
                border: 1px solid var(--border);
            }
        }

        /* Login Screen */
        #login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
            height: 100%;
        }
        #name-input {
            padding: 12px;
            font-size: 1em;
            width: 100%;
            max-width: 300px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }
        #join-btn {
            padding: 12px 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: var(--accent);
            color: var(--surface-color);
        }

        /* Main Chat Screen */
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        #chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .message {
            display: flex;
            margin-bottom: 1rem;
            max-width: 75%;
        }
        .message.mine {
            align-self: flex-end;
        }
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 18px;
            background-color: var(--bg-color);
        }
        .message.mine .message-bubble {
            background-color: var(--accent);
            color: var(--surface-color);
        }
        .message-sender {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        #form {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--border);
        }
        #message-input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 18px;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin-right: 0.5rem;
        }
        #send-btn {
            padding: 0.75rem 1rem;
            border: none;
            background-color: var(--accent);
            color: var(--surface-color);
            border-radius: 18px;
            cursor: pointer;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="login-container">
            <h1>Real-time Chat</h1>
            <input type="text" id="name-input" placeholder="Enter your name" />
            <button id="join-btn">Join Chat</button>
        </div>

        <div id="chat-container" class="hidden">
            <div id="chat-header">Public Chat Room</div>
            <div id="messages"></div>
            <form id="form">
                <input id="message-input" autocomplete="off" placeholder="Type a message..." />
                <button id="send-btn" type="submit">Send</button>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const ui = {
                loginContainer: document.getElementById('login-container'),
                nameInput: document.getElementById('name-input'),
                joinBtn: document.getElementById('join-btn'),
                chatContainer: document.getElementById('chat-container'),
                messages: document.getElementById('messages'),
                form: document.getElementById('form'),
                messageInput: document.getElementById('message-input'),
                sendBtn: document.getElementById('send-btn'),
            };

            let db, auth, userId, displayName;
            
            const appName = 'chat-app'; 
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-instance-id';

            try {
                const firebaseConfig = JSON.parse(window.__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Firebase Init Error:", error);
                alert("Could not connect to the service. Have you pasted your firebaseConfig keys?");
            }

            ui.joinBtn.addEventListener('click', async () => {
                displayName = ui.nameInput.value.trim();
                if (!displayName) {
                    alert("Please enter a name.");
                    return;
                }
                
                ui.loginContainer.classList.add('hidden');
                ui.chatContainer.classList.remove('hidden');

                await signInAndStart();
            });

            async function signInAndStart() {
                try {
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, user => {
                        if (user) {
                            userId = user.uid;
                            listenForMessages();
                        }
                    });
                } catch (error) {
                    console.error("Authentication Error:", error);
                    alert("Authentication failed. Please ensure your Firebase configuration is correct and you have enabled Anonymous Authentication in your Firebase project console.");
                    ui.messageInput.disabled = true;
                    ui.sendBtn.disabled = true;
                    ui.messageInput.placeholder = "Authentication failed.";
                }
            }

            ui.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageText = ui.messageInput.value.trim();

                if (messageText && userId) {
                    try {
                        await addDoc(collection(db, `artifacts/${appName}/${appId}/public/data/messages`), {
                            text: messageText,
                            sender: displayName,
                            uid: userId,
                            createdAt: serverTimestamp()
                        });
                        ui.messageInput.value = '';
                    } catch (error) {
                         console.error("Error sending message:", error);
                         alert("Could not send message.");
                    }
                } else if (!userId) {
                    console.error("Cannot send message, user is not authenticated.");
                    alert("Cannot send message. You are not connected to the chat service.");
                }
            });

            function listenForMessages() {
                const messagesRef = collection(db, `artifacts/${appName}/${appId}/public/data/messages`);
                const q = query(messagesRef, orderBy("createdAt"));

                onSnapshot(q, (snapshot) => {
                    const shouldScroll = ui.messages.scrollTop + ui.messages.clientHeight >= ui.messages.scrollHeight - 50;
                    
                    snapshot.docChanges().forEach(change => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('message');
                            if (data.uid === userId) {
                                messageDiv.classList.add('mine');
                            }

                            const bubble = document.createElement('div');
                            bubble.classList.add('message-bubble');

                            if (data.uid !== userId) {
                                const sender = document.createElement('div');
                                sender.classList.add('message-sender');
                                sender.textContent = data.sender;
                                bubble.appendChild(sender);
                            }
                            
                            const text = document.createElement('div');
                            text.textContent = data.text;
                            bubble.appendChild(text);

                            messageDiv.appendChild(bubble);
                            ui.messages.appendChild(messageDiv);
                        }
                    });

                    if(shouldScroll || snapshot.docChanges().some(change => change.type === 'added' && change.doc.data().uid === userId)) {
                        ui.messages.scrollTop = ui.messages.scrollHeight;
                    }
                });
            }
        });
    </script>
</body>
</html>

