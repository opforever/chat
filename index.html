<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat</title>
    <script type="module">
        // Your "Dev Apps" Firebase project configuration is now embedded.
        const firebaseConfig = {
          apiKey: "AIzaSyCc3e__RFg81ZD_hjap63V0w6wCAp2iIZU",
          authDomain: "dev-apps-d3c3e.firebaseapp.com",
          projectId: "dev-apps-d3c3e",
          storageBucket: "dev-apps-d3c3e.appspot.com",
          messagingSenderId: "603825738755",
          appId: "1:603825738755:web:0f0601020d17ae6fdfea36",
          measurementId: "G-46VVE0LXV2"
        };
        window.__firebase_config = JSON.stringify(firebaseConfig);

        if (typeof __app_id === 'undefined') {
            window.__app_id = 'default-chat-app';
        }
    </script>
    <style>
        :root {
            --bg-color-light: #e9e9ef;
            --surface-color-light: rgba(255, 255, 255, 0.8);
            --text-primary-light: #121212;
            --text-secondary-light: #5f5f5f;
            --accent-light: #007aff;
            --border-light: #e0e0e0;
            --bubble-bg-light: #f0f0f0;

            --bg-color-dark: #1c1c1e;
            --surface-color-dark: rgba(44, 44, 46, 0.7);
            --text-primary-dark: #ffffff;
            --text-secondary-dark: #8e8e93;
            --accent-dark: #0a84ff;
            --border-dark: #3a3a3c;
            --bubble-bg-dark: #2c2c2e;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: var(--bg-color-light);
                --surface-color: var(--surface-color-light);
                --text-primary: var(--text-primary-light);
                --text-secondary: var(--text-secondary-light);
                --accent: var(--accent-light);
                --border: var(--border-light);
                --bubble-bg: var(--bubble-bg-light);
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: var(--bg-color-dark);
                --surface-color: var(--surface-color-dark);
                --text-primary: var(--text-primary-dark);
                --text-secondary: var(--text-secondary-dark);
                --accent: var(--accent-dark);
                --border: var(--border-dark);
                --bubble-bg: var(--bubble-bg-dark);
            }
        }
        
        * {
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--surface-color);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 100vh;
            background-color: var(--surface-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        @media (min-width: 600px) {
            #app {
                max-height: 90vh;
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        /* Login Screen */
        #login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
            height: 100%;
        }
        #name-input {
            padding: 12px;
            font-size: 1em;
            width: 100%;
            max-width: 300px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }
        #join-btn {
            padding: 12px 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: var(--accent);
            color: white;
        }

        /* Main Chat Screen */
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        #chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            background-color: var(--surface-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 75%;
            align-self: flex-start;
            align-items: flex-end;
        }
        .message.mine {
            align-self: flex-end;
        }
        
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }
        .message.mine .avatar {
            display: none;
        }
        
        .message-content {
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 18px;
            background-color: var(--bubble-bg);
            word-wrap: break-word;
            text-align: left;
        }
        .message.mine .message-bubble {
            background-color: var(--accent);
            color: white;
            border-radius: 18px 18px 5px 18px;
        }
        .message:not(.mine) .message-bubble {
            border-radius: 18px 18px 18px 5px;
        }
        
        .message-sender {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-align: left;
        }

        #form {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-top: 1px solid var(--border);
            background-color: var(--surface-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        #message-input {
            flex-grow: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 18px;
            background-color: var(--bubble-bg);
            color: var(--text-primary);
            margin-right: 0.5rem;
        }
        #message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent);
        }
        #send-btn {
            padding: 0.75rem 1rem;
            border: none;
            background-color: var(--accent);
            color: white;
            border-radius: 18px;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        #send-btn:active {
            transform: scale(0.95);
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="login-container">
            <h1>Real-time Chat</h1>
            <input type="text" id="name-input" placeholder="Enter your name" />
            <button id="join-btn">Join Chat</button>
        </div>

        <div id="chat-container" class="hidden">
            <div id="chat-header">Public Chat Room</div>
            <div id="messages"></div>
            <form id="form">
                <input id="message-input" autocomplete="off" placeholder="Type a message..." />
                <button id="send-btn" type="submit">Send</button>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const ui = {
                loginContainer: document.getElementById('login-container'),
                nameInput: document.getElementById('name-input'),
                joinBtn: document.getElementById('join-btn'),
                chatContainer: document.getElementById('chat-container'),
                messages: document.getElementById('messages'),
                form: document.getElementById('form'),
                messageInput: document.getElementById('message-input'),
                sendBtn: document.getElementById('send-btn'),
            };

            let db, auth, userId, displayName;
            const appName = 'chat-app'; 
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-instance-id';
            const combinedAppId = `${appName}-${appId}`;
            const avatarColors = ['#e53935', '#d81b60', '#8e24aa', '#5e35b1', '#3949ab', '#1e88e5', '#039be5', '#00acc1', '#00897b', '#43a047', '#7cb342', '#c0ca33', '#fdd835', '#ffb300', '#fb8c00', '#f4511e', '#6d4c41', '#757575', '#546e7a'];

            try {
                const firebaseConfig = JSON.parse(window.__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Firebase Init Error:", error);
                alert("Could not connect to the service. Have you pasted your firebaseConfig keys?");
            }

            // --- Event Listeners ---

            ui.joinBtn.addEventListener('click', () => {
                const name = ui.nameInput.value.trim();
                if (name) {
                    displayName = name;
                    localStorage.setItem('chatDisplayName', displayName);
                    initChat();
                } else {
                    alert("Please enter a name.");
                }
            });
            
            ui.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageText = ui.messageInput.value.trim();
                if (!messageText) return;
                
                ui.sendBtn.disabled = true;
                // --- FIX: Clear input immediately ---
                ui.messageInput.value = '';

                await sendMessage({ text: messageText });
                
                ui.sendBtn.disabled = false;
                ui.messageInput.focus();
            });

            // --- Core Functions ---

            function initChat() {
                ui.loginContainer.classList.add('hidden');
                ui.chatContainer.classList.remove('hidden');
                signInAndStart();
            }

            async function signInAndStart() {
                try {
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, user => {
                        if (user) {
                            userId = user.uid;
                            listenForMessages();
                        }
                    });
                } catch (error) {
                    console.error("Authentication Error:", error);
                    alert("Authentication failed.");
                }
            }

            async function sendMessage(messageData) {
                if (!userId) {
                    console.error("Cannot send message, user is not authenticated.");
                    return;
                }
                try {
                    await addDoc(collection(db, `artifacts/${combinedAppId}/public/data/messages`), {
                        ...messageData,
                        sender: displayName,
                        uid: userId,
                        createdAt: serverTimestamp()
                    });
                } catch (error) {
                     console.error("Error sending message:", error);
                     alert("Could not send message.");
                }
            }

            function listenForMessages() {
                const messagesRef = collection(db, `artifacts/${combinedAppId}/public/data/messages`);
                const q = query(messagesRef, orderBy("createdAt"));

                onSnapshot(q, (snapshot) => {
                    const shouldScroll = ui.messages.scrollTop + ui.messages.clientHeight >= ui.messages.scrollHeight - 50;
                    
                    snapshot.docChanges().forEach(change => {
                        if (change.type === "added") {
                            renderMessage(change.doc.data());
                        }
                    });

                    if(shouldScroll || snapshot.docChanges().some(change => change.type === 'added' && change.doc.data().uid === userId)) {
                        ui.messages.scrollTop = ui.messages.scrollHeight;
                    }
                });
            }
            
            function getUserColor(uid) {
                let hash = 0;
                for (let i = 0; i < uid.length; i++) {
                    hash = uid.charCodeAt(i) + ((hash << 5) - hash);
                }
                return avatarColors[Math.abs(hash) % avatarColors.length];
            }

            function renderMessage(data) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                if (data.uid === userId) {
                    messageDiv.classList.add('mine');
                }

                const avatar = document.createElement('div');
                avatar.classList.add('avatar');
                avatar.textContent = data.sender.charAt(0).toUpperCase();
                avatar.style.backgroundColor = getUserColor(data.uid);
                messageDiv.appendChild(avatar);
                
                const messageContent = document.createElement('div');
                messageContent.classList.add('message-content');

                const sender = document.createElement('div');
                sender.classList.add('message-sender');
                sender.textContent = data.sender;
                if(data.uid !== userId) {
                    messageContent.appendChild(sender);
                }

                const bubble = document.createElement('div');
                bubble.classList.add('message-bubble');

                if (data.text) {
                    const text = document.createElement('div');
                    text.textContent = data.text;
                    bubble.appendChild(text);
                }

                messageContent.appendChild(bubble);
                messageDiv.appendChild(messageContent);
                ui.messages.appendChild(messageDiv);
            }

            // --- Initial Load ---
            const savedName = localStorage.getItem('chatDisplayName');
            if (savedName) {
                displayName = savedName;
                initChat();
            }
        });
    </script>
</body>
</html>

